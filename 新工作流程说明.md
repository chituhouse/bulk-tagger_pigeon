# 新工作流程说明

## 概述

根据您的反馈，我们优化了TXT文件创建的时机。现在的工作流程是：**API返回提示词后不立即创建TXT文件，而是等用户确认所有提示词后，统一导出TXT文件**。

## 新工作流程

### 1. 批量处理阶段
- ✅ API调用成功后，**不立即创建TXT文件**
- ✅ 提示词保存到manifest，状态设为`PENDING`（等待确认）
- ✅ 用户可以在审阅界面查看完整的中英文对照内容

### 2. 审阅确认阶段
- ✅ 用户在审阅界面查看提示词（显示完整中英文内容）
- ✅ 用户可以编辑提示词内容
- ✅ 用户点击"保存当前"、"通过"或"拒绝"确认提示词
- ✅ 确认后状态更新为`APPROVED`，但**仍不创建TXT文件**

### 3. 统一导出阶段
- ✅ 用户点击"导出TXT"按钮
- ✅ 系统显示状态统计（已确认/待确认数量）
- ✅ 只导出已确认（`APPROVED`）的提示词
- ✅ **TXT文件只包含英文部分**，用于LoRA训练

## 主要优势

### 1. 更好的用户控制
- 用户可以完全控制哪些提示词被导出为TXT
- 避免了不满意的提示词被误导出

### 2. 清晰的状态管理
- 明确区分"已生成"和"已确认"状态
- 提供详细的状态统计信息

### 3. 中英文分离
- 审阅界面显示完整中英文内容，方便查看
- TXT文件只包含英文部分，确保训练数据纯净

### 4. 批量导出效率
- 一次性导出所有已确认的提示词
- 避免重复的文件IO操作

## 操作示例

### 场景1：批量处理后统一导出
```
1. 批量处理 → 生成提示词 → 状态：PENDING
2. 逐个审阅 → 确认提示词 → 状态：APPROVED
3. 点击"导出TXT" → 统一创建TXT文件
```

### 场景2：部分确认后导出
```
1. 10张图片批量处理完成
2. 确认其中5张图片 → 状态：APPROVED
3. 点击"导出TXT" → 只导出5个TXT文件
4. 后续确认剩余5张 → 再次导出
```

## 界面变化

### 导出TXT按钮功能增强
- 显示详细的状态统计
- 确认导出对话框
- 只导出已确认的提示词
- 清晰的成功提示

### 审阅界面
- 显示完整中英文对照内容
- 确认操作不立即创建TXT文件
- 状态更新为APPROVED等待导出

## 技术实现

### 批量处理线程
```python
# 修改前：立即创建TXT文件
record.status = ProcessStatus.APPROVED
self._create_txt_file(image_path, prompt_en)

# 修改后：等待用户确认
record.status = ProcessStatus.PENDING
# 不立即创建TXT文件，等待用户统一导出
```

### 导出TXT函数
```python
def export_txt_files(self):
    # 统计状态
    approved_count = len(self.manifest_manager.get_approved_records())
    pending_count = len(self.manifest_manager.get_pending_records())
    
    # 只导出已确认的记录
    exported_count = self.manifest_manager.export_to_txt_files()
```

### 中英文分离
```python
# 在manifest.py的export_to_txt_files中
prompt_en, prompt_cn = split_chinese_english(record.prompt_en)
with open(txt_path, 'w', encoding='utf-8') as f:
    f.write(prompt_en)  # 只写入英文部分
```

## 用户体验改进

1. **更好的控制权**：用户完全控制导出时机
2. **清晰的状态反馈**：明确知道哪些已确认，哪些待确认
3. **避免误导出**：不满意的提示词不会被意外导出
4. **批量操作效率**：一次性处理所有已确认的提示词

这个新工作流程完全符合您的需求：**审阅界面显示完整中英文内容，TXT文件只输出英文部分，且只有在用户确认后才创建TXT文件**。 