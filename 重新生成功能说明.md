# 重新生成功能说明

## 功能概述

重新生成功能允许用户对已处理的图片重新调用 MiniMax API，生成新的英文提示词。这个功能特别适用于：

- 对当前生成的提示词不满意
- 想要尝试不同的提示词模板
- 需要重新处理失败的图片
- 调整提示词质量和风格

## 主要特性

### 1. 安全的重新生成流程
- ✅ 操作前确认对话框，防止误操作
- ✅ 显示当前重试次数和文件信息
- ✅ 支持取消操作

### 2. 完善的状态管理
- ✅ 防止重复点击（按钮禁用）
- ✅ 实时进度显示
- ✅ 线程安全的状态更新
- ✅ 自动清理线程资源

### 3. 智能的数据处理
- ✅ 自动更新 manifest 记录
- ✅ 增加重试计数器
- ✅ 重新设置为待审状态
- ✅ 自动创建 TXT 文件

### 4. 完备的错误处理
- ✅ API 调用失败处理
- ✅ 文件不存在检查
- ✅ 网络异常恢复
- ✅ 详细的错误提示

## 使用步骤

### 1. 准备工作
1. 确保已加载 manifest 文件
2. 输入有效的 API Key
3. 设置合适的提示词模板

### 2. 选择图片
1. 在图片列表中选择要重新生成的图片
2. 查看当前的提示词内容
3. 确认需要重新生成

### 3. 执行重新生成
1. 点击"重新生成"按钮
2. 在确认对话框中点击"是"
3. 等待 API 调用完成
4. 查看新生成的提示词

### 4. 结果处理
- 成功：新提示词自动保存，状态重置为待审
- 失败：显示错误信息，可重新尝试

## 技术实现

### 1. 后台线程处理
```python
class SingleImageProcessingThread(QThread):
    - 异步 API 调用
    - 可中断的处理流程
    - 进度信号发送
    - 错误处理和恢复
```

### 2. 状态管理
```python
def regenerate_current_image(self):
    - 输入验证
    - 文件存在检查
    - 线程状态检查
    - 用户确认
```

### 3. 回调处理
```python
def on_image_regenerated(self, img_path, prompt, success):
    - 更新 manifest 记录
    - 创建 TXT 文件
    - 刷新 UI 显示
    - 清理线程资源
```

## 注意事项

### 1. API 配置
- 确保 API Key 有效且有足够额度
- 检查网络连接状态
- 注意 API 调用频率限制

### 2. 文件管理
- 重新生成会覆盖原有提示词
- 自动创建的 TXT 文件会覆盖现有文件
- 建议定期备份重要数据

### 3. 性能考虑
- 单张图片处理，不会影响批量操作
- 支持中途取消操作
- 自动清理线程资源

### 4. 错误恢复
- API 调用失败时可重新尝试
- 网络异常会显示详细错误信息
- 支持手动重试机制

## 快捷键支持

- 当前暂无快捷键支持
- 建议后续版本添加 `Ctrl+R` 快捷键

## 未来改进

1. **批量重新生成**：支持选择多张图片同时重新生成
2. **提示词对比**：显示新旧提示词的对比界面
3. **自动重试**：API 失败时自动重试机制
4. **历史记录**：保存重新生成的历史记录
5. **快捷键**：添加键盘快捷键支持

## 故障排除

### 常见问题

1. **按钮无反应**
   - 检查是否选择了图片
   - 确认 API Key 是否正确
   - 查看是否有其他任务在运行

2. **API 调用失败**
   - 检查网络连接
   - 验证 API Key 有效性
   - 查看 API 额度是否充足

3. **文件创建失败**
   - 检查文件夹写入权限
   - 确认磁盘空间充足
   - 查看文件是否被其他程序占用

4. **程序无响应**
   - 等待 API 调用完成
   - 检查系统资源使用情况
   - 必要时重启程序

---

*本功能已在 v0.8.0 版本中完整实现并测试通过。* 